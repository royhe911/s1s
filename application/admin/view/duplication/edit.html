<style>
    .op {
        width: 150px !important;
    }
</style>
<div class="panel-heading row" style="padding:0 15px;color: #999;font-size: 12px; line-height: 50px; background-color: transparent">
    <div style="background-color: #e8edf0;width: 100%; height: 50px;padding-left: 15px">
        <div class="lf">
            <i class="fa fa-home" style="font-size: 14px;"></i>
        </div>
        <div class="panel-lead lf" style="margin: 0px;">商品管理&nbsp;&nbsp;&nbsp;> </div>
        <a href="<?php echo url('good/index');?>" class="panel-lead lf pl" style="margin: 0px; color: #999 !important;">&nbsp;&nbsp;商品列表&nbsp;&nbsp;&nbsp;> </a>
        <div class="panel-lead lf pl" style="margin: 0px;color: #34c191;">&nbsp;&nbsp;&nbsp;
            <?php echo empty($row) ? '添加商品': '编辑商品';?>
        </div>
    </div>
</div>
<div class="panel-body" id='panel-body'>
    <form id="edit-form" class="form-horizontal" role="form" data-toggle="validator" method="POST" action="">

        <input id="c-id" data-rule="required" class="form-control" name="" type="hidden" value="{$row.id ?? ''}">
        <div class="form-group">
            <label for="c-name" class="control-label col-xs-12 col-sm-2"><span style="color: #ff777c;">*</span> 选择门店:</label>
            <div class="col-xs-12 col-sm-8">
                <!--存在开始-->
                {if isset($row.shop_id) && $row.shop_id neq ''}
                <a id="add_shop_id" href="javascript:;" onclick="layer_open('选择门店', '/good/shop_list',{w:'1000px',y:'900px'})" class="btn btn-success btn-add hidden ac-error-box mr-10" title="选择门店" data-msg-empty="请选择门店" ><i class="fa fa-plus"></i> 选择门店</a>
                <div style="position: relative;padding: 7px 15px;display: inline-block;background: #fff;border: 1px solid #dddddd;">
                    <img onclick="del_store_val(this)" src="/assets/img/close_red.png" style="width: 13px;height: 13px;position: absolute;top: -5px;right: -5px;cursor:pointer">{$row.name ?? ''}
                </div>
                <input type="hidden" id="c-shop_id" value="{$row.shop_id}">
                {else}
                <!--存在结束-->
                <a id="add_shop_id" href="javascript:;" onclick="layer_open('选择门店', '/good/shop_list',{w:'1000px',y:'900px'})" class="btn btn-success btn-add ac-error-box mr-10" title="选择门店" data-msg-empty="请选择门店" ><i class="fa fa-plus"></i> 选择门店</a>
                <input type="hidden" id="c-shop_id" value="">
                {/if}
            </div>
        </div>
        <div class="form-group">
            <label for="c-name" class="control-label col-xs-12 col-sm-2"><span style="color: #ff777c;">*</span> 选择品牌:</label>
            <div class="col-xs-12 col-sm-8">
                <select class="form-control op ac-error-box" required="" name="c-brand_id" id="c-brand_id"  style="display: inline-block;width: 300px;margin-right: 10px;">
                    <option value="">请先选择品牌</option>
                    <?php if (!empty($brand_list)) foreach($brand_list as $key => $value){?>
                    <option value="{$value}" <?php if(isset($row['brand']) && $row['brand']==$value) echo 'selected';?>>{$value}</option>
                    <?php }?>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label for="c-name" class="control-label col-xs-12 col-sm-2"><span style="color: #ff777c;">*</span> 商品分类:</label>
            <div class="col-xs-12 col-sm-8">
                <select class="form-control op ac-error-box" required="" name="c-type_id" id="c-type_id"  style="display: inline-block;width: 300px;margin-right: 10px;">
                    <option value="0">请选择商品分类</option>
                    {$good_type|raw}
                </select>
            </div>
        </div>
        <div class="form-group">
            <label class="control-label col-xs-12 col-sm-2"><span style="color: #ff777c;">*</span> 商品名称:</label>
            <div class="col-xs-12 col-sm-8">
                <input id="c-title" data-rule="required" class="form-control ac-input" maxlength="80" type="text" value="{$row.title ?? ''}" data-msg-empty="请输入商品名称" style="display: inline-block;width: 300px;margin-right: 10px;">
            </div>
        </div>
        <div class="form-group row">
            <label class="control-label col-xs-12 col-sm-2"><span style="color: #ff777c;">*</span> 商品预览图:</label>
            <div class="col-xs-12 col-sm-10">
                <div class="l ac-img-container">
                    <div class="os-row">
                        {if isset($row.good_images) && $row.good_images neq ''}
                        {volist name='row.good_images' id='vo' length='5'}

                        {if $i eq 1}
                        <div class="formControls l mr-15 ta-imgItem ac-item-box" style="margin-bottom: 10px;">
                            <sup></sup>
                            <i class="os-radius"></i>
                            <img class="os-img" src="{$Think.config.qiniu.domain}{$vo.goods_image}" data-log="{$vo.goods_image}">
                        </div>
                        {else}
                        <div class="formControls l mr-15 ta-imgItem ac-item-box" style="margin-bottom: 10px;">
                            <i class="os-radius"></i>
                            <img class="os-img" src="{$Think.config.qiniu.domain}{$vo.goods_image}" data-log="{$vo.goods_image}">
                        </div>
                        {/if}

                        {/volist}
                        {if count($row.good_images) lt 5}
                        <div class="formControls l ta-imgItem ac-add" style="width: 100px;height: 100px;">
                            <img class="os-pointer" src="__CDN__/assets/img/defaultAdd.png" id="img">
                        </div>
                        {else}
                        <div class="formControls l ta-imgItem ac-add hidden" style="width: 100px;height: 100px;">
                            <img class="os-pointer" src="__CDN__/assets/img/defaultAdd.png" id="img">
                        </div>
                        {/if}
                        {else}
                        <div class="formControls l ta-imgItem ac-add" style="width: 100px;height: 100px;">
                            <img class="os-pointer" src="__CDN__/assets/img/defaultAdd.png" id="img">
                        </div>
                        {/if}
                    </div>
                </div>
            </div>
        </div>
        <div class="form-group">
            <label class="control-label col-xs-12 col-sm-2">商品价格:</label>
            <div class="col-xs-12 col-sm-8">
                <input id="c-price" data-rule="required" class="form-control ac-number op" type="text" value="{$row.price ?? ''}" style="display: inline-block;width: 300px;margin-right: 10px; width: 150px;" >
            </div>
        </div>
        <div class="form-group">
            <label class="control-label col-xs-12 col-sm-2"><span style="color: #ff777c;">*</span> 商品描述:</label>
            <div class="col-xs-12 col-sm-8">
                <script id="editor" type="text/plain"><?php echo !isset($html) ? '': htmlspecialchars_decode($html);?></script>
            </div>
        </div>
        <div class="form-group">
            <label class="control-label col-xs-12 col-sm-2"></label>
            <div class="col-xs-12 col-sm-8">
                <button type="button" class="btn btn-success btn-ok btn-embossed disabled">保 存</button>
                <!-- <button type="reset" class="btn btn-default btn-embossed">{:__('Reset')}</button> -->
            </div>
        </div>
    </form>
</div>
<script>window.UEDITOR_HOME_URL = '__CDN__/assets/libs/ueditor/1.4.3/'</script>
<script type="text/javascript" charset="utf-8" src="__CDN__/assets/libs/ueditor/1.4.3/ueditor.config.js?v={$site.version}"></script>
<script type="text/javascript" charset="utf-8" src="__CDN__/assets/libs/ueditor/1.4.3/ueditor.all.js?v={$site.version}"> </script>
<script type="text/javascript" charset="utf-8" src="__CDN__/assets/libs/ueditor/1.4.3/lang/zh-cn/zh-cn.js?v={$site.version}"></script>
<script type="text/javascript" charset="utf-8" src="__CDN__/assets/js/backend/error_msg.js?v={$site.version}"></script>
<script>
    function del_store_val(os_this) {
        var this_parent = $(os_this).parent();
        this_parent.prev().removeClass("hidden");
        this_parent.next().val("");
        console.log(this_parent.next());
        console.log(this_parent.next().val());

        this_parent.remove();
        var brand_item = $("#c-brand_id");
        brand_item.html('<option value="0">请先选择门店</option>');
    }
    (function () {
        up_img_System("img");
        $("#edit-form").on("click", ".ac-item-box i", function () {
            var os = $(this).parent();
            var add = os.nextAll(".ac-add");
            os.remove();
            var isMain = $("#edit-form .ac-item-box");
            if (os.children("sup").length != 0 && isMain.length > 0) {
                $(isMain[0]).prepend("<sup></sup>");
            }
            console.log(add.length);
            if (add.hasClass("hidden")) {
                add.removeClass("hidden");
            }
        });

        $("#edit-form .ac-number").on("input", function () {
            fun.inputNumber($(this),2);
        });

        //调用防错处理,start
        //公共的弹出框样式
        var public_style_error = {
            display: 'inline-block',
            'line-height': '34px',
            height: '34px',
            overflow: 'inherit'
        };
        // 输入框的必填项调用
        fun.error_msg_clear({}, public_style_error);
        //非必填输入框和div,select的防错处理
        fun.error_clear_box();
        //调用防错处理结束

        //商品名称验证方法
        function validate_title(id,is_focus) {
            var title =id;
            var title_obj = {
                element: title
            };
            if(is_focus) {
                title_obj.msg = title.attr("data-msg-empty");
                if(!fun.error_msg_create_input(title_obj,public_style_error)) {
                    return;
                }
            }else{
                title_obj.is_focus = false;
            }
            title_obj.msg = "您输入的商品名称过长";
            title_obj.type = "distance_limit_long";
            title_obj.str_length = 80;
            if(!fun.error_msg_create_input(title_obj,public_style_error)) {
                return;
            }
            title_obj.type = "reg";
            title_obj.is_reg = true;
            title_obj.msg = "您输入的商品名称中含有非法字符串";
            if(!fun.error_msg_create_input(title_obj,public_style_error)) {
                return;
            }
            return title.val();
        }

        $("#c-title").on("blur", function () {
            validate_title($(this));
        });
        $('.btn-ok').click(function () {
            var msg = {};
            msg.ids = $('#c-id').val();

//            选择门店
            var shop_id = $('#c-shop_id');
            var city_element = $("#add_shop_id");
            var shop_id_obj = {
                msg:"请选择门店",
                element:city_element
            };
            var shop_id_val = shop_id.val();
            if(shop_id_val=="") {
                fun.error_msg_create_box(shop_id_obj,public_style_error);
                return;
            }else{
                msg.shop_id = shop_id_val;
            }

//            选择品牌
            var brand_id = $("#c-brand_id");
            var brand_id_val = brand_id.val();
            msg.brand_id= brand_id_val;

//            商品分类
            var type_id = $("#c-type_id");
            var type_id_val = type_id.val();
            var type_id_obj = {
                msg:"请选择商品分类",
                element:type_id
            };
            if(type_id_val==0) {
                fun.error_msg_create_box(type_id_obj,public_style_error);
                return;
            }else{
                msg.type_id= type_id_val;
            }

            //标题验证
            var title = validate_title($("#c-title"), true);
            if(typeof title=="string"){
                msg.title = title;
            }else{
                return;
            }

            //图片验证
            var image = $(".ac-img-container").find("img");
            var image_arr = [],bool=true;
            for(var n=0;n<image.length;n++) {
                var src = $(image[n]).attr("data-log");
                if(typeof(src)!="undefined") {
                    image_arr.push(src);
                    bool = false;
                }
            }
            if (bool) {
                layer.msg('请上传商品预览图片');
                return false;
            }
            msg.image = JSON.stringify(image_arr);
            //价格验证
            msg.price = $('#c-price').val();
            //商品描述
            var desc = UE.getEditor('editor', {}).getContent();
            if(desc=="") {
                layer.msg("请输入商品描述");
                return;
            }else{
                msg.desc=desc
            }
//            {id: id, shop_id: shop_id, brand_id: brand_id, type_id: type_id, title: title, image: image, price: price, desc: desc}
            $.post('', msg, function (data) {
                if (data.code == 1) {
                    layer.msg(data.msg, {
                        time: 2000 //2秒关闭（如果不配置，默认是3秒）
                    }, function () {
                        window.parent.location.reload();
                    });
                } else {
                    layer.msg(data.msg);
                }
            })
        })
    })();
    $(function () {
        var ue = UE.getEditor('editor', {
            serverUrl: '/Ueditor/index?prefix=shops',
            toolbars: [
                [],
                ['fullscreen', 'source', 'undo', 'redo', 'bold', 'indent', 'italic', 'underline', 'pasteplain', 'selectall', 'time', 'date', 'inserttable', 'fontfamily', 'fontsize'],
                ['insertimage', 'simpleupload', 'link', 'spechars', 'justifyleft', 'justifyright', 'justifycenter', 'justifyjustify', 'forecolor', 'backcolor', 'autotypeset', 'touppercase', 'tolowercase']
            ],
            videoUrlPrefix: '',
            inputXssFilter: false,
            initialFrameWidth:"500",
            initialFrameHeight:"300"
        });
    });

</script>
