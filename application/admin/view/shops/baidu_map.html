<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Hello, World</title>
    <style type="text/css">
        html{height:80%}
        body{height:100%;margin:0px;padding:0px}
        #container{height:100%}
        .baidu_map_box{
            width: 500px;
            /*height: 700px;*/
            margin: 20px auto;
        }
        .baidu_map_box #r-result{
            width: 500px;
            /*height: 30px;*/
            font-size: 14px;
            /*margin-top: 10px;*/
            margin-bottom: 20px;
        }
        .baidu_map_box #postBtn{
            display: block;
            margin: 20px auto 0;
            /*margin-bottom: 10px;*/
        }
    </style>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=mDml72vqmPtHmZHl7tus153lx9e1pg8A">
        //v2.0版本的引用方式：src="http://api.map.baidu.com/api?v=2.0&ak=您的密钥"
    </script>
</head>

<body>
    <div class="baidu_map_box">
        <input type="hidden" id="container_value" data-lng="{$city.lng}" data-lat="{$city.lat}">
        <div id="r-result">请输入搜索地址:  <input type="text" id="suggestId" size="20" value="百度" style="width:150px;" /></div>
        <div id="container" style="width: 500px; height: 500px;"></div>
        <button id="postBtn" type="button" class="btn btn-success btn-ok btn-embossed">保 存</button>
    </div>
    <script type="text/javascript">
        var map = new BMap.Map("container");
        // 创建地图实例
        var point = new BMap.Point('{$city.lng}', '{$city.lat}');
        // 创建点坐标
        map.centerAndZoom(point, 12);

        // 初始化地图，设置中心点坐标和地图级别
        var marker = new BMap.Marker(point);        // 创建标注
        map.addOverlay(marker);                     // 将标注添加到地图中
        marker.setAnimation(BMAP_ANIMATION_BOUNCE); // 跳动的动画

        map.enableScrollWheelZoom();   //启用滚轮放大缩小，默认禁用
        map.enableContinuousZoom();    //启用地图惯性拖拽，默认禁用

        // 单点选址
        var geoc = new BMap.Geocoder();
        function showInfo(e){
            var pt = e.point;
            map.clearOverlays();
            console.log(pt.lng + ", " + pt.lat);
            $('#container_value').attr('data-lng', pt.lng);
            $('#container_value').attr('data-lat', pt.lat);
            map.addOverlay(new BMap.Marker(pt));
            // geoc.getLocation(pt, function(rs){
            //     var addComp = rs.addressComponents;
            //     console.log(addComp.province + ", " + addComp.city + ", " + addComp.district + ", " + addComp.street + ", " + addComp.streetNumber);
            // });
        }
        map.addEventListener("click", showInfo);

        // 添加带有定位的导航控件
        var navigationControl = new BMap.NavigationControl({
            // 靠左上角位置
            anchor: BMAP_ANCHOR_TOP_LEFT,
            // LARGE类型
            type: BMAP_NAVIGATION_CONTROL_LARGE,
            // 启用显示定位
            enableGeolocation: true
        });
        map.addControl(navigationControl);


        // 百度地图API功能(搜索)
        function G(id) {
            return document.getElementById(id);
        }

        var ac = new BMap.Autocomplete(    //建立一个自动完成的对象
            {"input" : "suggestId"
                ,"location" : map
            });

        ac.addEventListener("onhighlight", function(e) {  //鼠标放在下拉列表上的事件
            var str = "";
            var _value = e.fromitem.value;
            var value = "";
            if (e.fromitem.index > -1) {
                value = _value.province +  _value.city +  _value.district +  _value.street +  _value.business;
            }
            str = "FromItem<br />index = " + e.fromitem.index + "<br />value = " + value;

            value = "";
            if (e.toitem.index > -1) {
                _value = e.toitem.value;
                value = _value.province +  _value.city +  _value.district +  _value.street +  _value.business;
            }
            str += "<br />ToItem<br />index = " + e.toitem.index + "<br />value = " + value;
            //G("searchResultPanel").innerHTML = str;
        });

        var myValue;
        ac.addEventListener("onconfirm", function(e) {    //鼠标点击下拉列表后的事件
            var _value = e.item.value;
            myValue = _value.province +  _value.city +  _value.district +  _value.street +  _value.business;
            //G("searchResultPanel").innerHTML ="onconfirm<br />index = " + e.item.index + "<br />myValue = " + myValue;

            setPlace();
        });

        function setPlace(){
            map.clearOverlays();    //清除地图上所有覆盖物
            function myFun(){
                var pp = local.getResults().getPoi(0).point;    //获取第一个智能搜索的结果
                map.centerAndZoom(pp, 18);
                map.addOverlay(new BMap.Marker(pp));    //添加标注

                map.clearOverlays();
                console.log(pp.lng + ", " + pp.lat);
                $('#container_value').attr('data-lng', pp.lng);
                $('#container_value').attr('data-lat', pp.lat);
                map.addOverlay(new BMap.Marker(pp));
                // geoc.getLocation(pp, function(rs){
                //     var addComp = rs.addressComponents;
                //     console.log(addComp.province + ", " + addComp.city + ", " + addComp.district + ", " + addComp.street + ", " + addComp.streetNumber);
                // });
            }
            var local = new BMap.LocalSearch(map, { //智能搜索
                onSearchComplete: myFun
            });
            local.search(myValue);
        }


        $('#postBtn').click(function () {
            var lng = $('#container_value').attr('data-lng');
            var lat = $('#container_value').attr('data-lat');
            if (lng == '' || lng == undefined || lat == '' || lng == '') {
                layer.msg('请重新选取定位');
                return false;
            }
            $.post('/region/check_city_info_lal', {lng: lng, lat: lat}, function (data) {
                if (data.code == 1) {
                    var region_id_3 = parent.$("#region_id_3");
                    // region_id_3.prev().addClass("hidden");
                    // region_id_3.before('<div  style="position: relative;padding: 7px 15px;display: inline-block;background: #fff;border: 1px solid #dddddd;">' +
                    //     '<img onclick="del_store_val(this)" src="'+public_file+'/assets/img/close_red.png" style="width: 13px;height: 13px;position: absolute;top: -5px;right: -5px;cursor:pointer"/>'
                    //     + store_name +'' +
                    //     '</div>');
                    region_id_3.val(data.data.region_info_3.name);
                    region_id_3.attr('data-region_id_3', data.data.region_info_3.region_id_3);

                    var region_id_4 = parent.$("#region_id_4");
                    region_id_4.children().remove();
                    var html_flag = '<option value="0">--商圈--</option>';
                    var data_region_4 = data.data.region_list_4;
                    $.each(data_region_4, function(i, val) {
                        html_flag = html_flag + '<option value="' + val.id + '">' + val.name + '</option>'
                    });
                    region_id_4.append(html_flag);

                    var address = parent.$('#address');
                    address.val(data.data.address);

                    var coordinate = parent.$('#coordinate');
                    coordinate.val(lng + ',' + lat);

                    parent.$("#address").css('display', 'block');
                    parent.$('#address-error').hide();

                    parent.layer.closeAll();
                } else {
                    layer.msg(data.msg);
                    return false;
                }
            }, 'json');
        });
    </script>
</body>
</html>