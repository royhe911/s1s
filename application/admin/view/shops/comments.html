
<script type="text/javascript" src="__CDN__/assets/libs/laydate5/laydate.js"></script>
<script src="__CDN__/assets/js/vue.min.js"></script>
<style>
    .form-control {
        margin-right: 10px;
        padding:6px 15px!important;
    }
    .fixed-table-toolbar{
        position:relative;
        padding-right:110px;
    }
    .num{
        width:100px;
        position:absolute;
        top:12px;
        right:10px;
    }
    .num .num_list{
        width:100px;
    }
    @media screen and (max-width:1090px) {
        .shop-s,.pull-left{
            margin-top: 10px ;
        }
    }
</style>
<div class="panel panel-default panel-intro">
    <div class="panel-heading row" style="padding-top:0;color: #999;font-size: 12px; line-height: 50px; background-color: transparent">
        <!-- <div class="panel-lead"><em>门店分类管理</em></div> -->
        <div style="background-color: #e8edf0;width: 100%; height: 50px;padding-left: 15px">
            <div class="lf">
                <i class="fa fa-home" style="font-size: 14px;"></i>
            </div>
            <a href="<?php echo url('shops/index');?>" class="panel-lead lf" style="margin: 0px; color: #656565 !important;">门店管理&nbsp;&nbsp;&nbsp;> </a>
            <div class="panel-lead lf pl" style="margin: 0px;color: #34c191;">&nbsp;&nbsp;&nbsp;门店评论</div>
        </div>
    </div>
    <div class="panel-body">
        <div id="myTabContent" class="tab-content">
            <div class="tab-pane fade active in" id="one">
                <div class="widget-body no-padding">
                    <div class="bootstrap-table">
                        <div class="fixed-table-toolbar">
                            <div class="bs-bars pull-left">
                                <div id="toolbar" class="toolbar" style="position: relative;">
                                    <form id="search_form" class="form-inline" role="form" data-toggle="validator" method="get" action="">
                                        <input class="form-control pull-left title-input" v-model="key_word" name="key_word" type="text" placeholder="评论关键词">
                                        <input class="form-control title-input pull-left" v-model="nickname" name="nickname" type="text" placeholder="用户昵称">
                                        <input class="form-control title-input pull-left" v-model="shop_name" name="shop_name" type="text" placeholder="门店名称">

                                        <!--新增筛选-->
                                        <select class="pull-left form-control title-input" name="status">
                                            <option value="-1">全部状态</option>
                                            <option value="1" {if 1 == $status}selected{/if}>已回复</option>
                                            <option value="0" {if 0 == $status}selected{/if}>未回复</option>
                                        </select>
                                        <select class="pull-left form-control title-input" name="device">
                                            <option value="0">全部来源</option>
                                            {volist name='device' id='vo'}
                                            <option value="{$key}" {if $key eq $Think.get.device}selected{/if}>{$vo}</option>
                                            {/volist}
                                        </select>
                                        <select class="pull-left form-control title-input" name="region_id_3" onchange='javascript:get_type("region_id_4", this.value, 0)'>
                                            <option value="">区</option>
                                            {volist name='region_list_3' id='vo'}
                                            <option value="{$key}" {if $Request.get.region_id_3 eq $key}selected{/if}>{$vo}</option>
                                            {/volist}
                                        </select>
                                        <select class="pull-left form-control title-input" name="region_id_4" id="region_id_4">
                                            <option value="">商圈</option>
                                        </select>
                                        <select class="pull-left form-control title-input" name="score" v-model="score">
                                            <option value="">星级</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                        </select>
                                        <div class='pull-left' style="margin-right: 10px;">
                                            <input class="input-text laydate-icon os-pl-10" style="width: 180px; height: 36px;padding-left: 8px;font-size: 12px;border:1px solid #d2d6de" type="text" id="fromTime" name="from_time" placeholder="搜索时间区间" onfocus="this.blur()"/>
                                        </div>
                                        <button type="submit" class="btn btn-success btn-ok btn-embossed table-input shop-s" style="background-color: #34c191;">{:__('搜索')}</button>
                                    </form>
                                </div>
                            </div>

                            <!--显示条数显示条数显示条数显示条数-->
                            <div class="num">
                                <select class="pull-left form-control title-input num_list" name="" id="">
                                    <option value="0">查看条数</option>
                                    {volist name='page_list' id='vo'}
                                    <option value="{$vo}" {if $Think.session.cur_limit eq $vo}selected{/if}>{$vo}</option>
                                    {/volist}
                                </select>
                            </div>

                        </div>
                        <p style="float: right;font-size: 12px;padding: 8px; margin: 0">共计
                            <span style="color: #34c191;">{$list->total()}</span> 条评论</p>
                        <div id="show_data" class="fixed-table-container" style="padding-bottom: 0px;">
                            <div class="fixed-table-header" style="display: none;">
                                <table></table>
                            </div>
                            <div class="fixed-table-body">
                                <table id="table" class="table table-striped table-bordered table-hover" data-operate-edit="1" data-operate-del="1" width="100%">
                                    <thead>
                                    <tr style="background-color: #e8f7f2;">
                                        <th style="text-align: center; vertical-align: middle; " data-field="id">
                                            <div class="th-inner ">Id</div>
                                            <div class="fht-cell"></div>
                                        </th>
                                        <th style="text-align: center; vertical-align: middle; " data-field="name">
                                            <div class="th-inner ">用户昵称</div>
                                            <div class="fht-cell"></div>
                                        </th>
                                        <th style="text-align: center; vertical-align: middle; " data-field="status">
                                            <div class="th-inner ">区</div>
                                            <div class="fht-cell"></div>
                                        </th>
                                        <th style="text-align: center; vertical-align: middle; " data-field="status">
                                            <div class="th-inner ">商圈</div>
                                            <div class="fht-cell"></div>
                                        </th>
                                        <th style="text-align: center; vertical-align: middle; " data-field="status">
                                            <div class="th-inner ">门店名称</div>
                                            <div class="fht-cell"></div>
                                        </th>
                                        <th style="text-align: center; vertical-align: middle; " data-field="status">
                                            <div class="th-inner ">评价星级</div>
                                            <div class="fht-cell"></div>
                                        </th>
                                        <th style="text-align: center; vertical-align: middle; " data-field="status">
                                            <div class="th-inner ">评价时间</div>
                                            <div class="fht-cell"></div>
                                        </th>

                                        <!--新增字段新增字段新增字段新增字段新增字段新增字段新增字段-->
                                        <th style="text-align: center; vertical-align: middle; " data-field="status">
                                            <div class="th-inner ">来源</div>
                                            <div class="fht-cell"></div>
                                        </th>
                                        <th style="text-align: center; vertical-align: middle; " data-field="status">
                                            <div class="th-inner ">状态</div>
                                            <div class="fht-cell"></div>
                                        </th>
                                        <th style="text-align: center; vertical-align: middle; " data-field="status">
                                            <div class="th-inner ">操作</div>
                                            <div class="fht-cell"></div>
                                        </th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {volist name='list' id='vo'}
                                    <tr data-id="{$vo.id}">
                                        <th style="text-align: center; vertical-align: middle; " data-field="id">
                                            {$vo.id}
                                        </th>
                                        <th style="text-align: center; vertical-align: middle; " data-field="name">
                                            <div class=" setEllipsis" style="width: 20em; display: inline-block;" title='{$vo.nickname}'>
                                                {$vo.nickname}
                                            </div>
                                        </th>
                                        <th style="text-align: center; vertical-align: middle; " data-field="status">
                                            <div class=" setEllipsis" style="width: 10em; display: inline-block" title="{$region_data[$city_id][$vo.region_id_3]['name'] ?? ''}">
                                                {$region_data[$city_id][$vo.region_id_3]['name'] ?? ''}
                                            </div>
                                        </th>
                                        <th style="text-align: center; vertical-align: middle; " data-field="status">
                                            <div class=" setEllipsis" style="width: 6em; display: inline-block" title="{$region_data[$vo.region_id_3][$vo.region_id_4]['name'] ?? ''}">
                                                {$region_data[$vo.region_id_3][$vo.region_id_4]['name'] ?? ''}
                                            </div>
                                        </th>
                                        <th style="text-align: center; vertical-align: middle; " data-field="status">
                                            <div class=" setEllipsis" style="width: 20em; display: inline-block" title='{$vo.shop_name}'>
                                                {$vo.shop_name}
                                            </div>
                                        </th>
                                        <th style="text-align: center; vertical-align: middle; " data-field="status">
                                            <div class="star-box-tem" style="margin: 0 auto;">
                                                <div class="cover-image containCenter">
                                                </div>
                                                <div class="cover-green" style="width: {:getStarNumber($vo.score ?? 0)}px;"></div>
                                                <div class="cover-grey"></div>
                                            </div>
                                        </th>
                                        <th style="text-align: center; vertical-align: middle; " data-field="status">
                                            {$vo.create_time}
                                        </th>

                                        <!--新增新增新增新增新增新增新增-->
                                        <th style="text-align: center; vertical-align: middle; " data-field="status">
                                            {$device[$vo.device] ?? ''}
                                        </th>
                                        <th style="text-align: center; vertical-align: middle; " data-field="status">
                                            {$vo.is_reply == 1 ? '已回复' : '未回复'}
                                        </th>

                                        <th style="text-align: center; vertical-align: middle; " data-field="operate">
                                            <a class="editCC" style="color: #9f9f9f; margin-right:5px; display: inline-block" href="javascript:void(0)" data-id="{$vo.id}" title="查看">
                                                <i class="iconfont icon-chakan"></i>
                                            </a>
                                            {if $vo.is_delete eq 0}
                                            <a class="deleteCC" style="color: #9f9f9f; margin-right:5px; display: inline-block" href="javascript:void(0)" data-id="{$vo.id}" title="删除">
                                                <i class="iconfont icon-shanchu"></i>
                                            </a>
                                            {/if}
                                        </th>
                                    </tr>
                                    {/volist}
                                    </tbody>
                                </table>
                                <script>
                                    $('.editCC').click(function () {
                                        var url = '<?php echo url("shops/comment");?>' + '?id=' + $(this).parent().parent().attr('data-id');
                                        layer_open('评论详情', url,{w:'800px',h:'617px'});
                                    });
                                    //  改变显示条数
                                    $('.num_list').change(function(){
                                        var value=$(this).find('option:selected').val();
                                        var key_word=$('input[name="key_word"]').val();
                                        var nickname=$('input[name="nickname"]').val();
                                        var shop_name=$('input[name="shop_name"]').val();
                                        var status=$('select[name="status"]').find('option:selected').val();
                                        var device=$('select[name="device"]').find('option:selected').val();
                                        var region=$('select[name="region"]').find('option:selected').val();
                                        var circle=$('select[name="circle"]').find('option:selected').val();
                                        var score=$('select[name="score"]').find('option:selected').val();
                                        var from_time=$('input[name="from_time"]').val();
                                        location.href = 'comments?cur_limit=' + value+'&key_word='+key_word+'&nickname='+nickname+'&shop_name='+shop_name+
                                            '&region='+region+'&circle='+circle+'&score='+score+'&from_time='+from_time+'&status='+status+'&device='+device;
                                    })


                                    // 编辑状态
                                    $('.statusCC').click(function () {
                                        var formData = {},url,htmlInstance = $(this);
                                        formData.id = $(this).parent().parent().attr('data-id');
                                        formData.is_show = $(this).attr('data-is_show');
                                        url = '<?php echo url("shops/edit_comment");?>';

                                        formData.is_show = (formData.is_show == 1) ? 0: 1;

                                        $.ajax({
                                            type: 'POST',
                                            url: url,
                                            data: formData,
                                            success: function (result) {
                                                //提示层
                                                layer.msg(result.msg);
                                                if (result.code == 1) {
                                                    htmlInstance.attr('data-is_show', formData.is_show);
                                                    if (formData.is_show == 1){
                                                        htmlInstance.attr('title', "停用");
                                                        htmlInstance.children('i').removeClass('fa-toggle-off').addClass('fa-toggle-on');
                                                    }else {
                                                        htmlInstance.attr('title', "启用");
                                                        htmlInstance.children('i').removeClass('fa-toggle-on').addClass('fa-toggle-off');
                                                    }

                                                }
                                            },
                                            error: function(msg){
                                                //提示层
                                                layer.msg('服务器忙，请稍后··');
                                            },
                                            dataType: 'JSON'
                                        });

                                    });

                                    // 删除相关数据
                                    $('.deleteCC').click(function () {
                                        var formData = {},url,htmlInstance = $(this);
                                        formData.id = $(this).parent().parent().attr('data-id');
                                        url = '<?php echo url("shops/delete_comment");?>';

                                        //询问框
                                        layer.confirm('您确定要删除该数据？', {
                                            btn: ['确定','取消'] //按钮
                                        }, function(){
                                            $.ajax({
                                                type: 'POST',
                                                url: url,
                                                data: formData,
                                                success: function (result) {
                                                    //提示层
                                                    layer.msg(result.msg);
                                                    if (result.code == 1) htmlInstance.parent().parent().empty();
                                                },
                                                error: function(msg){
                                                    //提示层
                                                    layer.msg('服务器忙，请稍后··');
                                                },
                                                dataType: 'JSON'
                                            });
                                        });
                                    });
                                </script>
                            </div>
                            <div class="fixed-table-footer" style="display: none;">
                                <table>
                                    <tbody>
                                    <tr></tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="fixed-table-pagination">{$list->render()|raw}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    var regionsJson = <?php echo json_encode($region_data);?>;
    var form_shop_name = "<?php echo empty($_GET['shop_name']) ? '': $_GET['shop_name'];?>";
    var form_key_word = "<?php echo empty($_GET['key_word']) ? '': $_GET['key_word'];?>";
    var form_nickname = "<?php echo empty($_GET['nickname']) ? '': $_GET['nickname'];?>";
    var form_city_id = "<?php echo empty($city_id) ? '': $city_id;?>";
    var form_region = "<?php echo empty($_GET['region']) ? '': $_GET['region'];?>";
    var form_circle = "<?php echo empty($_GET['circle']) ? '': $_GET['circle'];?>";
    var form_score = "<?php echo !isset($_GET['score']) ? '': $_GET['score'];?>";

    var from_time = "<?php echo !isset($_GET['from_time']) ? '': $_GET['from_time'];?>";
    var end_time = "<?php echo !isset($_GET['end_time']) ? '': $_GET['end_time'];?>";

    var search_form = new Vue({
        el: '#search_form',
        data: {
            shop_name: form_shop_name,
            key_word: form_key_word,
            nickname: form_nickname,
            city: form_city_id,
            region: form_region,
            circle: form_circle,
            score: form_score,
            from_time: from_time,
            end_time: end_time,
            regionsJson: regionsJson
        }
    });
    /**
     * 加载时间插件
     */
    laydate.render({
        elem: '#fromTime'
        ,range: true
        ,value: "{$Request.get.from_time ?? ''}"
    });

    $(function () {
        {notempty name='Request.get.region_id_3'}
        get_type("region_id_4", '{$Request.get.region_id_3}', 0, '{$Request.get.region_id_4}');
        {/notempty}
        })

</script>